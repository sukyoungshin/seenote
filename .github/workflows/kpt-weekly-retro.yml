name: ğŸ”„ Weekly KPT Discussion Creator
description: 'ë§¤ì£¼ ìë™ìœ¼ë¡œ Discussionsì— íšŒê³  í…œí”Œë¦¿ ìƒì„±'

on:
  schedule:
    - cron: '0 12 * * 0' # ë§¤ì£¼ ì¼ìš”ì¼ ì˜¤í›„ 9ì‹œ (KST ê¸°ì¤€)
  workflow_dispatch:

jobs:
  create-kpt-discussion:
    runs-on: ubuntu-latest
    steps:
      - name: ì´ë²ˆ ì£¼ ì •ë³´ ê³„ì‚°
        id: date
        run: |
          node <<'EOF'
          const BASE_DATE = new Date('2025-06-02');
          const now = new Date();

          // ì£¼ì°¨ ê³„ì‚°: ê¸°ì¤€ì¼ë¡œë¶€í„° ëª‡ ì£¼ê°€ ì§€ë‚¬ëŠ”ì§€ ê³„ì‚° (1ë¶€í„° ì‹œì‘)
          const msPerWeek = 7 * 24 * 60 * 60 * 1000;
          const diffInWeeks = Math.floor((now - BASE_DATE) / msPerWeek) + 1;

          // ì´ë²ˆ ì£¼ ì›”~ì¼ ê³„ì‚°
          const startDate = new Date(now);
          startDate.setDate(now.getDate() - now.getDay() + 1); // ì›”ìš”ì¼
          const endDate = new Date(startDate);
          endDate.setDate(startDate.getDate() + 6); // ì¼ìš”ì¼

          function format(d) {
            return d.toISOString().split('T')[0];
          }

          const title = `[KPT] Week ${diffInWeeks} - ${format(startDate)} ~ ${format(endDate)}`;
          const body = `## ğŸ“… Week ${diffInWeeks} - ${format(startDate)} ~ ${format(endDate)}\n\n### âœ… Keep\n- \n\n### ğŸ¤” Problem\n- \n\n### ğŸš€ Try\n- `;

          console.log(`::set-output name=title::${title}`);
          console.log(`::set-output name=body::${body}`);
          EOF

      - name: Discussions ê¸€ ìë™ ìƒì„±
        env:
          GH_TOKEN: ${{ secrets.GH_DISCUSSION_TOKEN }}
        run: |
          curl -X POST -H "Authorization: Bearer $GH_TOKEN" -H "Content-Type: application/json" \
          -d '{
            "query": "mutation CreateDiscussion { createDiscussion(input: {repositoryId: \"R_kgDOOwv0aA\", categoryId: \"DIC_kwDOOwv0aM4Cqto8\", title: \"${{ steps.date.outputs.title }}\", body: \"${{ steps.date.outputs.body }}\"}) { discussion { id } } }"
          }' https://api.github.com/graphql
