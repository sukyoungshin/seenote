name: ğŸ”„ Weekly KPT Discussion Creator
description: 'ë§¤ì£¼ ìë™ìœ¼ë¡œ Discussionsì— íšŒê³  í…œí”Œë¦¿ ìƒì„±'

on:
  schedule:
    - cron: '0 12 * * 0' # ë§¤ì£¼ ì¼ìš”ì¼ ì˜¤í›„ 9ì‹œ (KST ê¸°ì¤€)
  workflow_dispatch:

jobs:
  create-kpt-discussion:
    runs-on: ubuntu-latest
    steps:
      - name: ì´ë²ˆ ì£¼ ì •ë³´ ê³„ì‚°
        id: date
        run: |
          node <<'EOF'
          const BASE_DATE = new Date('2025-06-02');
          const now = new Date();

          // ì£¼ì°¨ ê³„ì‚°: ê¸°ì¤€ì¼ë¡œë¶€í„° ëª‡ ì£¼ê°€ ì§€ë‚¬ëŠ”ì§€ ê³„ì‚° (1ë¶€í„° ì‹œì‘)
          const msPerWeek = 7 * 24 * 60 * 60 * 1000;
          const diffInWeeks = Math.floor((now - BASE_DATE) / msPerWeek) + 1;

          // ì´ë²ˆ ì£¼ ì›”~ì¼ ê³„ì‚°
          const startDate = new Date(now);
          startDate.setDate(now.getDate() - now.getDay() + 1); // ì›”ìš”ì¼
          const endDate = new Date(startDate);
          endDate.setDate(startDate.getDate() + 6); // ì¼ìš”ì¼

          function format(d) {
            return d.toISOString().split('T')[0];
          }

          const title = `[KPT] [Week ${diffInWeeks}] ${format(startDate)} ~ ${format(endDate)}`;
          const body = `### ğŸŸ¢ Keep\n- \n\n### ğŸ”´ Problem\n- \n\n### ğŸŸ¡ Try\n- `;

          const fs = require('fs');
          fs.writeFileSync('./discussion-payload.json', JSON.stringify({ title, body }));
          EOF

      - name: Discussions ê¸€ ìë™ ìƒì„± (GraphQL + jq ì•ˆì „ ì²˜ë¦¬)
        env:
          GH_TOKEN: ${{ secrets.GH_DISCUSSION_TOKEN }}
        run: |
          TITLE=$(jq -r .title discussion-payload.json)
          BODY=$(jq -r .body discussion-payload.json)

          echo "ğŸ“Œ ìƒì„±ë  ì œëª©: $TITLE"
          echo "ğŸ“Œ ìƒì„±ë  ë³¸ë¬¸:"
          echo "$BODY"

          jq -n \
            --arg query 'mutation CreateDiscussion($title: String!, $body: String!) { createDiscussion(input: {repositoryId: "R_kgDOOwv0aA", categoryId: "DIC_kwDOOwv0aM4Cqto8", title: $title, body: $body}) { discussion { id } } }' \
            --arg title "$TITLE" \
            --arg body "$BODY" \
            '{ query: $query, variables: { title: $title, body: $body } }' > mutation.json

          cat mutation.json

          curl -s -X POST -H "Authorization: Bearer $GH_TOKEN" -H "Content-Type: application/json" \
            --data @mutation.json \
            https://api.github.com/graphql | tee graphql-response.json

          echo "âœ… GraphQL ì‘ë‹µ ê²°ê³¼:"
          cat graphql-response.json
